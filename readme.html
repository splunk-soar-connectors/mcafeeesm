<!-- 
File: readme.html

Copyright (c) Phantom Cyber Corporation, 2016-2018

This unpublished material is proprietary to Phantom Cyber.
All rights reserved. The methods and
techniques described herein are considered trade secrets
and/or confidential. Reproduction or distribution, in whole
or in part, is forbidden except by express written permission
of Phantom Cyber.
-->

    <p>
    McAfee ESM identifies, correlates, and remediates information security threat events. The McAfee ESM app enables the collection of these events and the corresponding event related information into containers and artifacts in Phantom.
    </p>
    <p>
    NOTE: This app deprecates an older app named "McAfee Nitro". Please delete the older app if installed on Phantom and re-create the asset.
    </p>
    <p>
    The first thing to do is create the McAfee ESM asset in Phantom and fill up the Device URL, the User name and the Password. The other values can be left in the default state for now.
    <br>
    However it's good practice to set the Label of the objects from this source to a <b>NEW ENTRY</b> called <b>Event</b>.
    </p>
    <br>
    <p>
    Once the asset is saved, run Test Connectivity and make sure it passes. The Test Connectivity action attempts to validate the User name and the Password that the user has provided by connecting to the configured Device URL. The connection is tested by creating a session for the User name and Password pair, the session will be established upon the authentication of the credentials. Then the action also executes the query using the created session. And finally the created session is closed.
    <br>
    </p>
    <p>
    The Test connection action is successful only when the session is created and the REST API call is made successfully during the session and the session is closed without any problems.
    </p>
    <p>
    <br>
    Now that the config is out of the way, let's delve into the two modes that ingestion can occur and the differences between them. One thing to note is that for every event that is ingested, a single container  containing an Event artifact is created.<br>
    <br>
    <a href="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/container_list.png">
        <img src="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/container_list.png"/>
      </a><br>
    The container contains the raw data regarding the event that is acquired from the SIEM while the key details regarding the event are stored in the artifact of the container.
    </a>
    <a href="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/artifact.png">
        <img src="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/artifact.png"/>
    </a>
<h2>POLL NOW</h2>
    <p>
    POLL NOW should be used to get a sense of the containers and artifacts that are created by the app. The POLL NOW dialog allows the user to set the "Maximum containers" that should be ingested at this instance. Since a single container is created for each event, this value equates to the maximum events that are ingested by the app. The app will fetch the events in the order they were created in the SIEM. The app allows the user to ingest events up to 1 year old, this time interval can be configured in minutes using the <b>poll_time</b> asset config, For e.g. to ingest events that have been generated in the last 20 minutes, configure this value to be 20. However the query to ingest this data can be quite time consuming. In some cases the query will timeout with an error message <i>Query not completed in the configured time. Please increase the query_timeout value in the asset config and try again.</i> If you run into this error, you will need to tune the <b>poll_time</b> and <b>query_timeout</b> parameters to values that allow you to ingest enough data during POLL NOW within a large enough time out value.
    </p>
<h2>Scheduled Polling</h2>
    <p>
       This mode is used to schedule a polling action on the asset at regular intervals, which is configured via the INGEST SETTINGS tab of the asset. It makes use of the following asset configuration parameters (among others):

    <ul>
    <li>Maximum events to poll first time</li>
    The app detects the first time it is polling an asset and will ingest these number of events (at the most). It will also use the <b>poll_time</b> value.
    <li>Maximum Containers for scheduled polling</li>
        For all scheduled polls after the first, the app will ingest these number of events.
    </ul>
    <p>In case of Scheduled Polling, on every poll, the app remembers the time of the last event that it has ingested and will pickup from the same time in the next polling cycle.
    For best results, keep the poll interval and <i>Maximum  Containers for scheduled polling</i> values close to the number of events you would get within a time interval. This way, every poll will end up ingesting all the new events.<br>
    It is also very important that the <i>Maximum Container for scheduled  polling</i> configured should be greater than maximum events that are generated <b>per second</b>. If the app detects it got the maximum configured events and all occurred in the same second, it will start polling from the next second in the next polling cycle.
    </p>
<h2>Containers created</h2>
  As mentioned before, the app will create a single container for each event that it ingests with a single artifact called Event Artifact.
  <h3>Filtering Events</h3>
  Configure filters in the asset config <b>filters</b> field to limit the type and number of events that get ingested into Phantom (only the matching events get ingested). The filter format is a json string and defined by the McAfee ESM API. A simple e.g. could be:
  <pre>
   [{
    "type": "EsmFieldFilter",
    "field": {"name": "Action"},
    "operator": "EQUALS",
    "values": [{
        "type": "EsmBasicValue",
        "value": "8"
    }]
   }]
</pre>
The McAfee ESM installation has documentation on this format and can be found at:
<ul>
  <li>https://[mcafee_esm_ip]/rs/esm/help/commands/qryExecuteDetail</li>
  <li>https://[mcafee_esm_ip]/rs/esm/help/types/EsmFilter</li>
</ul>
Few things to note:
<ul>
  <li>The input is a json string which has to be a list. The action validates this.</li>
  <li>Not all event fields can be filtered on, to get the keys that can be used in a fiter, look at the results of the <b>list fields</b> action.</li>
</ul>
A very common case is to filter on the event types. One way to accomplish this is to expand the event details and note down the Signature ID of the event that you want to ingest into Phantom. For example to ingest events named <b>User Logon</b>, note down the <i>Signature ID</i>. In the screen-shot below this happens to be <i>306-11</i>.
    <br>
    <a href="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/esm_events.png">
        <img src="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/esm_events.png"/>
    </a>
    <br>
    <br>
This value can then be used to match the key named <b>DSIDSigID</b> using the filter:
  <pre>
   [{
    "type": "EsmFieldFilter",
    "field": {"name": "DSIDSigID"},
    "operator": "EQUALS",
    "values": [{
        "type": "EsmBasicValue",
        "value": "306-11"
    }]
   }]
</pre>

<h2>Event Artifact</h2>
      The details regarding the event that are acquired from the API call to the McAfee SIEM will be collected and the data that are related to the type of event are all stored into the CEF fields and are added to the artifact. The fields that are present in the artifact greatly depend upon the type of the event that was created. Different events will have different types of values in the artifacts.
    <br>
    <a href="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/event_artifact.png">
        <img src="/app_resource/mcafeeesm_1d20c51a-7f60-465b-a8e3-fc02967bec4d/img/event_artifact.png"/>
    </a>
    <br>
